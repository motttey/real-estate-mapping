<!DOCTYPE html>
<html>
  <body>
    <div id="main">
      <svg id="map"></svg>
    </div>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

    <script type="text/javascript">

      const width = 1500;
      const height = 1500;

      $.get("./JapanCityGeoJson/geojson/prefectures/13.json", function(data){
      	var data_parsed = $.parseJSON(data);
        var projection = d3.geoMercator()
                    .center([ 139.70, 35.64 ])
                    .translate([width/2, height/2])
                    .scale(96000);

        var geoPath = d3.geoPath().projection(projection);
        var svg = d3.select("#map")
          .attr("width",width)
          .attr("height",height);

        var map = svg.selectAll("path").data(data_parsed.features)
          .enter()
          .append("path")
            .attr("d", geoPath)
            .style("stroke", "#5EAFC6")
            .style("stroke-width", 1)
            .style("fill", "#ffffff");

        var tooltip = d3.select("#main")
          	.append("div")
            .attr("id", "tooltip")
          	.style("position", "absolute")
          	.style("visibility", "hidden")
          	.text("tooltip");
        /*
        plotCoordinates(projection, "output_yokohama.json", "yokohama", "red");
        plotCoordinates(projection, "output_musako.json", "musako", "blue");
        */

        plotCoordinates(projection, "output_ebisu.json", "ebisu", "red");
        plotCoordinates(projection, "output_shibuya.json", "shibuya", "darkred");
        plotCoordinates(projection, "output_jiyugaoka.json", "jiyugaoka", "lime");

        // plotCoordinates(projection, "output_sinjuku.json", "sinjuku", "cyan");
        plotCoordinates(projection, "output_shinagawa.json", "shinagawa", "yellow");
        plotCoordinates(projection, "output_meguro.json", "meguro", "orange");
        plotCoordinates(projection, "output_ikebukuro.json", "ikebukuro", "green");
        plotCoordinates(projection, "output_kichijoji.json", "kichijoji", "blue");

        plotStations(projection);
      });

      function plotStations(projection) {
        var stations = [
          {"name": "吉祥寺駅", "lng": 139.58, "lat": 35.703056},
          {"name": "恵比寿駅", "lng": 139.709739, "lat": 35.647156},
          {"name": "品川駅", "lng": 139.736571, "lat": 35.6284756},
          {"name": "目黒駅", "lng": 139.7212501, "lat": 35.6285136},
          {"name": "自由が丘駅", "lng": 139.6657348, "lat": 35.6074068},
          {"name": "渋谷駅", "lng": 139.6994471, "lat": 35.6580382},
          {"name": "池袋駅", "lng": 139.7087114, "lat": 35.7295071},
        ];

        var projected_coordinate = [];
        stations.forEach(function(d){
          projected_coordinate.push(projection([d["lng"], d["lat"]]));
        });

        // https://easyramble.com/latitude-and-longitude-per-kilometer.html
        var kilometor = projection([0.009, 0])[0] - projection([0, 0])[0];
        console.log(kilometor);

        var circles_g = d3.select("svg").append('g')
                .attr('id', 'stations_circle');

        var circles = circles_g.selectAll('.stations_circle')
            .data(projected_coordinate)
            .enter()
            .append('circle')
            .attr('class', 'stations_circle')
            .attr('cx', function(d){
              return d[0];
            })
            .attr('cy', function(d){
              return d[1];
            })
            .attr('r', kilometor)
            .attr('stroke', "black")
            .attr('fill', "white")
            .style('opacity', '0.7');
      }

      function calcPolygonArea(polygon) {
        let N = polygon.length;
        let polygon_area = 0;
        polygon.forEach(function(d, i){
          if (i!==N-1) {
            polygon_area += d[0] * polygon[i+1][1] - polygon[1+i][0] * d[1];
          } else {
            polygon_area += d[0] * polygon[0][1] - polygon[0][0] * d[1];
          }
        });
        return Math.abs(polygon_area * 0.5);
      }

      function plotCoordinates(projection, filename, id, color) {
        $.get("./" + filename, function(coordinates_raw){
          var projected_coordinate = [];
          var coordinates = $.parseJSON(coordinates_raw);
          console.log(coordinates);

          coordinates.forEach(function(d){
            projected_coordinate.push(projection([d["lng"], d["lat"]]));
          });

          var circles_g = d3.select("svg").append('g')
                  .attr('id', 'circles_' + id);

          var polygon = d3.polygonHull(projected_coordinate.map(function(d){
              return [d[0], d[1]];
          }));

          var polygon_area = calcPolygonArea(polygon);
          console.log(projected_coordinate.length, polygon_area);

          var hull_g = circles_g.append("g")
              .attr("class", "hull_g");

          var hull = hull_g.append("path");

          hull.datum(polygon)
              .attr("d", function(d) { return "M" + d.join("L") + "Z"; })
              .attr("fill", function(d){
                  return color;
              })
              .attr("stroke", function(d){
                  return color;
              })
              .attr("opacity", "0.3")
              .attr("id", function(d){
                  return id + "_hull";
              });

          var circles = circles_g.selectAll("circle")
              .data(projected_coordinate)
              .enter()
              .append('circle')
              .attr('class', 'estate_circle')
              .attr('cx', function(d){
                return d[0];
              })
              .attr('cy', function(d){
                return d[1];
              })
              .attr('r', 1)
              .attr('stroke', color)
              .attr('fill', color)
              .on('mouseover', function(d,i){
                d3.select("#tooltip")
                  .style("visibility", "visible")
                  .style("top", (event.pageY-10)+"px").style("left",(event.pageX+10)+"px")
                  .text(coordinates[i]["name"]);
              });
        });

      }
    </script>
  </body>
</html>
