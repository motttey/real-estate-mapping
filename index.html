<!DOCTYPE html>
<html>
  <body>
    <div id="main">
      <div id="map_div" style="position:fixed;">
        <svg id="map"> </svg>
      </div>
      <div id="hull_div" style="position:fixed;">
        <svg id="hull"> </svg>
      </div>
      <div id="plot_div" style="position:fixed;">
        <svg id="plot"> </svg>
      </div>
      <div id="anotation_div" style="position:fixed; pointer-events: none;">
        <svg id="anotation"> </svg>
      </div>
    </div>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

    <script type="text/javascript">
      const stations = [
        {"name": "Yokohama", "lng": 139.6201192, "lat": 35.4657901},
        {"name": "Ebisu", "lng": 139.709739, "lat": 35.647156},
        {"name": "Kichijoji", "lng": 139.58, "lat": 35.703056},
        {"name": "Shinagawa", "lng": 139.736571, "lat": 35.6284756},
        {"name": "Ikebukuro", "lng": 139.7087114, "lat": 35.7295071},
        {"name": "Musashikosugi", "lng": 139.657272, "lat": 35.5766378},
        {"name": "Shinjuku", "lng": 139.6895924, "lat": 35.6982244},
        {"name": "Meguro", "lng": 139.7212501, "lat": 35.6285136},
        {"name": "Omiya", "lng": 139.6216608, "lat": 35.9064528},
        {"name": "Urawa", "lng": 139.6562868, "lat": 35.8583478},
        {"name": "Shibuya", "lng": 139.6994471, "lat": 35.6580382},
        {"name": "Nakameguro", "lng": 139.6966557, "lat": 35.6441631},
        {"name": "Jiyugaoka", "lng": 139.6657348, "lat": 35.6074068},
        {"name": "Kamakura", "lng": 139.5105125, "lat": 35.331778},
        {"name": "Nakano", "lng": 139.663569, "lat": 35.7056142},
        {"name": "Futakotamagawa", "lng": 139.6252443, "lat": 35.6123586},
        {"name": "Funabashi", "lng": 139.9826962, "lat": 35.7017527},
        {"name": "Akabane", "lng": 139.7163193, "lat": 35.7795679},
        {"name": "Kawasaki", "lng": 139.694695, "lat": 35.5313693},
        {"name": "Kashiwa", "lng": 139.9687232, "lat": 35.8621541},
        {"name": "Tachikawa", "lng": 139.4115521, "lat": 35.6979144},
        {"name": "Kitasenju", "lng": 139.8031493, "lat": 35.7496806},
        {"name": "Ogikubo", "lng": 139.603315, "lat": 35.70471},
        {"name": "Omotesando", "lng": 139.7098981, "lat": 35.6652554},
        {"name": "Ebina", "lng": 139.3887433, "lat": 35.4526059},
        {"name": "Sakuragicho", "lng": 139.6288723, "lat": 35.4509537},
        {"name": "Tsudanuma", "lng": 140.0182132, "lat": 35.6912192},
        {"name": "Saitama-Shintoshin", "lng": 139.631547, "lat": 35.8937993},
        {"name": "Ueno", "lng": 139.7752151, "lat": 35.7141715},
        {"name": "Maihama", "lng": 139.885078, "lat": 35.6349019}, // wrong
        {"name": "Sangenchaya", "lng": 139.6692071, "lat": 35.643621},
        {"name": "Machida", "lng": 139.4630475, "lat": 35.5498564},
        {"name": "Akihabara", "lng": 139.7709203, "lat": 35.6983573},
        {"name": "Fujisawa", "lng": 139.485438, "lat": 35.3385319},
        {"name": "Chohu", "lng": 139.5426079, "lat": 35.6517667},
        {"name": "Shimokitazawa", "lng": 139.664788, "lat": 35.6615272},
        {"name": "Mitaka", "lng": 139.5588351, "lat": 35.7027199},
        {"name": "Kawagoe", "lng": 139.458202, "lat": 35.9044475},
        {"name": "Tama-Praza", "lng": 139.5563338, "lat": 35.5774101},
        {"name": "Maihama", "lng": 139.885078, "lat": 35.6349019},
      ];

      const width = 1500;
      const height = 1500;

      const city_length = 40;
      console.log(stations);
      const zoom = d3.zoom()
       .scaleExtent([1, 40])
       .translateExtent([[0,0], [width, height]])
       .extent([[0, 0], [width, height]])
       .on("zoom", zoomed);

      // ボタンなどのUIと関連付けて表示/非表示できるようにする
      var visible_towns = [0,1,2,3,4,5,6,7,8,9,10,11,12];

      var svg = d3.select("#map")
        .attr("width", width)
        .attr("height", height);

      var plots_svg = d3.select("#plot")
        .attr("width", width)
        .attr("height", height)
        .call(zoom);

      var hulls_svg = d3.select("#hull")
        .attr("width", width)
        .attr("height", height);

      var anotation_svg = d3.select("#anotation")
        .attr("width", width)
        .attr("height", height);

      var tooltip = d3.select("#main")
          .append("div")
          .attr("id", "tooltip")
          .style("position", "absolute")
          .style("visibility", "hidden")
          .text("tooltip");

      var projection = d3.geoMercator()
          .center([ 139.70, 35.64 ])
          .translate([width/2, height/2])
          .scale(64000);

      // https://easyramble.com/latitude-and-longitude-per-kilometer.html
      var kilometor = projection([0.0090133729745762, 0])[0] - projection([0, 0])[0];
      console.log(kilometor);

      const red_gray_grad = d3.interpolate("red", "gray");
      $.when(
        plotPrefecture(11, projection),
        plotPrefecture(12, projection),
        plotPrefecture(13, projection),
        plotPrefecture(14, projection),
        plotAllEstate(projection),
      ).done(function(){
        plotStations(projection);
      });

      function zoomed() {
        d3.selectAll("g").attr("transform", d3.event.transform);
      }

      function plotAllEstate(projection){
        for (var i = 0; i < city_length; i++) {
            let id = ('000' + i).slice(-3);
            // if (i!== 29 && visible_towns.indexOf(i) > 0) {
            if (i!== 29) {
              plotCoordinates(projection, "output"+id+".json", i, red_gray_grad(i/city_length));
            }
        }
      }

      function plotPrefecture(id, projection){
        $.get("./JapanCityGeoJson/geojson/prefectures/"+id+".json", function(data){
            var data_parsed = $.parseJSON(data);
            var geoPath = d3.geoPath().projection(projection);

            var prefecture_group =  d3.select("svg").append("g").attr("class", "prefecture_g")

            var map = prefecture_group.selectAll("path")
              .data(data_parsed.features)
              .enter()
              .append("path")
                .attr("d", geoPath)
                .style("stroke", "gray")
                .style("stroke-width", 1)
                .style("fill", "#ffffff");
        });
      }

      function plotStations(projection) {
        var projected_coordinate = [];
        stations.forEach(function(d){
          projected_coordinate.push(projection([d["lng"], d["lat"]]));
        });

        var circles_g = d3.select("#anotation").append('g')
                .attr('id', 'stations_circle');

        var circles = circles_g.selectAll('.stations_circle')
            .data(projected_coordinate)
            .enter()
            .append('circle')
            .attr('class', 'stations_circle')
            .attr('cx', function(d){
              return d[0];
            })
            .attr('cy', function(d){
              return d[1];
            })
            .attr('r', kilometor)
            .attr('stroke', "black")
            .attr('fill', "none")
            .style('opacity', '0.7');

        var text = circles_g.selectAll('.stations_text')
            .data(projected_coordinate)
            .enter()
            .append("text")
            .attr('class', 'stations_text')
            .attr('x', function(d){
              return d[0];
            })
            .attr('y', function(d){
              return d[1];
            })
            .text(function(d,i){
                console.log( stations[i]);
                return stations[i]["name"];
            });

      }

      function calcPolygonArea(polygon) {
        let N = polygon.length;
        let polygon_area = 0;
        polygon.forEach(function(d, i){
          if (i!==N-1) {
            polygon_area += d[0] * polygon[i+1][1] - polygon[1+i][0] * d[1];
          } else {
            polygon_area += d[0] * polygon[0][1] - polygon[0][0] * d[1];
          }
        });
        return Math.abs(polygon_area * 0.5);
      }

      function plotCoordinates(projection, filename, id, color) {
        $.get("./" + filename, function(coordinates_raw){
          var projected_coordinate = [];
          var coordinates = $.parseJSON(coordinates_raw);
          console.log(coordinates);

          var total_distance = 0;
          console.log(id);
          coordinates.forEach(function(d){
            d["city_id"] = id;
            total_distance += Math.sqrt( Math.pow(d["lng"]-stations[id]["lng"], 2) + Math.pow(d["lat"]-stations[id]["lat"], 2) );
            projected_coordinate.push(projection([d["lng"], d["lat"]]));
          });

          var circles_g = d3.select("#plot").append('g')
                  .attr('class', 'estate_circles_g')
                  .attr('id', 'circles_' + id);

          var hull_g = d3.select("#hull").append('g')
                  .attr('class', 'estate_hull_g')
                  .attr('id', 'hulls_' + id);

          var polygon = d3.polygonHull(projected_coordinate.map(function(d){
              return [d[0], d[1]];
          }));

          var polygon_area = calcPolygonArea(polygon);
          var polygon_centroid = d3.polygonCentroid(polygon);
          console.log(coordinates[0]["name"]);
          console.log(projected_coordinate.length, polygon_area);
          console.log("total_distance", total_distance);
          console.log("average_distance", (total_distance/projected_coordinate.length) * (1/0.0090133729745762));

          var hull = hull_g.append("path");

          hull.datum(polygon)
              .attr("d", function(d) { return "M" + d.join("L") + "Z"; })
              .attr("fill", function(d){
                  return color;
              })
              .attr("stroke", function(d){
                  return color;
              })
              .attr("opacity", "0.2")
              .attr("id", function(d){
                  return id + "_hull";
              });

          var circles = circles_g.selectAll("circle")
              .data(projected_coordinate)
              .enter()
              .append('circle')
              .attr('class', 'estate_circle')
              .attr('cx', function(d){
                return d[0];
              })
              .attr('cy', function(d){
                return d[1];
              })
              .attr('r', 1)
              .attr('stroke', color)
              .attr('fill', color)
              .style('opacity', function(d,i){
                return 0.5;
              })
              .on('mouseover', function(d,i){
                d3.select("#tooltip")
                  .style("visibility", "visible")
                  .style("top", (event.pageY-10)+"px").style("left",(event.pageX+10)+"px")
                  .text(coordinates[i]["name"]);
              });
        });

      }
    </script>
  </body>
</html>
