<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8"/>
    <title>Town map</title>
  </head>
  <body>
    <div id="main">
      <div id="map_div" style="position:fixed;">
        <svg id="map"> </svg>
      </div>
      <div id="hull_div" style="position:fixed;">
        <svg id="hull"> </svg>
      </div>
      <div id="plot_div" style="position:fixed;">
        <svg id="plot"> </svg>
      </div>
      <div id="anotation_div" style="position:fixed; pointer-events: none;">
        <svg id="anotation"> </svg>
      </div>
    </div>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="./main.js"></script>

    <script type="text/javascript">
      const stations = [
        {"name": "Yokohama", "lng": 139.6201192, "lat": 35.4657901},
        {"name": "Ebisu", "lng": 139.709739, "lat": 35.647156},
        {"name": "Kichijoji", "lng": 139.58, "lat": 35.703056},
        {"name": "Shinagawa", "lng": 139.736571, "lat": 35.6284756},
        {"name": "Ikebukuro", "lng": 139.7087114, "lat": 35.7295071},
        {"name": "Musashikosugi", "lng": 139.657272, "lat": 35.5766378},
        {"name": "Shinjuku", "lng": 139.6895924, "lat": 35.6982244},
        {"name": "Meguro", "lng": 139.7212501, "lat": 35.6285136},
        {"name": "Omiya", "lng": 139.6216608, "lat": 35.9064528},
        {"name": "Urawa", "lng": 139.6562868, "lat": 35.8583478},
        {"name": "Shibuya", "lng": 139.6994471, "lat": 35.6580382},
        {"name": "Nakameguro", "lng": 139.6966557, "lat": 35.6441631},
        {"name": "Jiyugaoka", "lng": 139.6657348, "lat": 35.6074068},
        {"name": "Kamakura", "lng": 139.5105125, "lat": 35.331778},
        {"name": "Nakano", "lng": 139.663569, "lat": 35.7056142},
        {"name": "Futakotamagawa", "lng": 139.6252443, "lat": 35.6123586},
        {"name": "Funabashi", "lng": 139.9826962, "lat": 35.7017527},
        {"name": "Akabane", "lng": 139.7163193, "lat": 35.7795679},
        {"name": "Kawasaki", "lng": 139.694695, "lat": 35.5313693},
        {"name": "Kashiwa", "lng": 139.9687232, "lat": 35.8621541},
        {"name": "Tachikawa", "lng": 139.4115521, "lat": 35.6979144},
        {"name": "Kitasenju", "lng": 139.8031493, "lat": 35.7496806},
        {"name": "Ogikubo", "lng": 139.603315, "lat": 35.70471},
        {"name": "Omotesando", "lng": 139.7098981, "lat": 35.6652554},
        {"name": "Ebina", "lng": 139.3887433, "lat": 35.4526059},
        {"name": "Sakuragicho", "lng": 139.6288723, "lat": 35.4509537},
        {"name": "Tsudanuma", "lng": 140.0182132, "lat": 35.6912192},
        {"name": "Saitama-Shintoshin", "lng": 139.631547, "lat": 35.8937993},
        {"name": "Ueno", "lng": 139.7752151, "lat": 35.7141715},
        {"name": "Maihama", "lng": 139.885078, "lat": 35.6349019}, // wrong
        {"name": "Sangenchaya", "lng": 139.6692071, "lat": 35.643621},
        {"name": "Machida", "lng": 139.4630475, "lat": 35.5498564},
        {"name": "Akihabara", "lng": 139.7709203, "lat": 35.6983573},
        {"name": "Fujisawa", "lng": 139.485438, "lat": 35.3385319},
        {"name": "Chohu", "lng": 139.5426079, "lat": 35.6517667},
        {"name": "Shimokitazawa", "lng": 139.664788, "lat": 35.6615272},
        {"name": "Mitaka", "lng": 139.5588351, "lat": 35.7027199},
        {"name": "Kawagoe", "lng": 139.458202, "lat": 35.9044475},
        {"name": "Tama-Praza", "lng": 139.5563338, "lat": 35.5774101},
        {"name": "Maihama", "lng": 139.885078, "lat": 35.6349019},
      ];

      const width = 1500;
      const height = 1500;

      const city_length = 40;
      console.log(stations);
      const zoom = d3.zoom()
       .scaleExtent([1, 40])
       .translateExtent([[0,0], [width, height]])
       .extent([[0, 0], [width, height]])
       .on("zoom", zoomed);

      // ボタンなどのUIと関連付けて表示/非表示できるようにする
      var visible_towns = [0,1,2,3,4,5,6,7,8,9,10,11,12];

      var svg = d3.select("#map")
        .attr("width", width)
        .attr("height", height)
        .style("background-color", "black");

      var plots_svg = d3.select("#plot")
        .attr("width", width)
        .attr("height", height)
        .call(zoom);

      var hulls_svg = d3.select("#hull")
        .attr("width", width)
        .attr("height", height);

      var anotation_svg = d3.select("#anotation")
        .attr("width", width)
        .attr("height", height);

      var tooltip = d3.select("#main")
          .append("div")
          .attr("id", "tooltip")
          .style("position", "absolute")
          .style("visibility", "hidden")
          .text("tooltip");

      var projection = d3.geoMercator()
          .center([ 139.70, 35.64 ])
          .translate([width/2, height/2])
          .scale(64000);

      // https://easyramble.com/latitude-and-longitude-per-kilometer.html
      var kilometor = projection([0.0090133729745762, 0])[0] - projection([0, 0])[0];
      console.log(kilometor);

      const red_gray_grad = d3.interpolate("red", "gray");
      const while_blue_grad = d3.interpolate("black", "blue");

      $.when(
        plotPrefecture(11, projection, 1000000),
        plotPrefecture(12, projection, 1000000),
        plotPrefecture(13, projection, 1000000),
        plotPrefecture(14, projection, 1000000),
        plotAllEstate(projection),
      ).done(function(){
        plotStations(projection, stations);
      });

      function zoomed() {
        d3.selectAll("g").attr("transform", d3.event.transform);
      }


    </script>
  </body>
</html>
